{% extends 'base.html' %}

{% block title %}Inbox{% endblock %}

{% block content %}
<style>
    .tab-container {
        display: flex;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 20px;
    }
    .tab {
        padding: 10px 20px;
        cursor: pointer;
        font-weight: bold;
        color: #6c757d;
    }
    .tab.active {
        color: #007bff;
        border-bottom: 2px solid #007bff;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .search-bar {
        margin-bottom: 20px;
    }
    .search-bar input {
        width: 100%;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 20px;
    }
    .chat-item, .user-item, .group-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
    }
    .chat-item img, .user-item img, .group-item img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .chat-info, .user-info, .group-info {
        flex: 1;
    }
    .chat-info h3, .user-info h3, .group-info h3 {
        margin: 0;
        font-size: 16px;
    }
    .chat-info p, .user-info p, .group-info p {
        margin: 0;
        font-size: 12px;
        color: #6c757d;
    }
    .chat-meta, .user-actions, .group-actions {
        text-align: right;
    }
    .chat-meta small, .user-actions button, .group-actions button {
        font-size: 12px;
        color: #6c757d;
    }
    .user-actions button, .group-actions button {
        margin-left: 10px;
        padding: 5px 10px;
        border: none;
        background: #007bff;
        color: white;
        border-radius: 5px;
        cursor: pointer;
    }
    .user-actions button:disabled, .group-actions button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    .new-group-form {
        padding: 20px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        display: none;
    }
    .new-group-form.active {
        display: block;
    }
    .chat-window {
        display: none;
        padding: 20px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }
    .chat-window.active {
        display: block;
    }
</style>

<div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search Chats and Groups" oninput="searchInbox()">
</div>

<div class="tab-container">
    <div class="tab active" onclick="showTab('chats')">Chats {% if unread_chats_count %} ({{ unread_chats_count }}) {% endif %}</div>
    <div class="tab" onclick="showTab('groups')">Groups {% if unread_groups_count %} ({{ unread_groups_count }}) {% endif %}</div>
    <div class="tab" onclick="showTab('new')">New</div>
    <div class="tab" onclick="showTab('search')">Search</div>
</div>

<div id="chats" class="tab-content active">
    {% if chats %}
        {% for chat in chats %}
        <div class="chat-item" onclick="openChat({{ chat.other_user.id }})">
            <img src="{{ chat.other_user.profilePhoto | default('/static/img/default_profile.png') }}" alt="Profile">
            <div class="chat-info">
                <h3>{{ chat.other_user.real_name }}</h3>
                <p>{{ chat.latest_message_snippet }}</p>
            </div>
            <div class="chat-meta">
                <small>{{ moment(chat.timestamp).fromNow() }}</small>
                {% if chat.unread_count > 0 %}
                <small class="unread">{{ chat.unread_count }}</small>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="chat-item">
            <p>No direct messages yet.</p>
            <p>Start a conversation with a friend!</p>
        </div>
    {% endif %}
</div>

<div id="groups" class="tab-content">
    {% if groups %}
        {% for group in groups %}
        <div class="chat-item" onclick="openGroupChat({{ group.id }})">
            <img src="{{ group.profilePhoto | default('/static/img/default_group.png') }}" alt="Group">
            <div class="chat-info">
                <h3>{{ group.name }}</h3>
                <p>{{ group.latest_message_snippet }}</p>
            </div>
            <div class="chat-meta">
                <small>{{ moment(group.timestamp).fromNow() }}</small>
                {% if group.unread_count > 0 %}
                <small class="unread">{{ group.unread_count }}</small>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="chat-item">
            <p>No group chats yet.</p>
            <p>Create a new group or join an existing one!</p>
        </div>
    {% endif %}
</div>

<div id="new" class="tab-content">
    <div class="new-group-form">
        <form method="POST" action="{{ url_for('create_group') }}" enctype="multipart/form-data">
            <div>
                <label>Upload Photo</label>
                <input type="file" name="groupPhoto" accept="image/*">
            </div>
            <div>
                <label>Group Name</label>
                <input type="text" name="groupName" required>
            </div>
            <button type="submit">Create Group</button>
            <button type="button" onclick="showTab('chats')">Cancel</button>
        </form>
    </div>
</div>

<div id="search" class="tab-content">
    <div id="search-results">
        <p>Start typing to search for mutual friends or groups.</p>
    </div>
</div>

<div class="chat-window" id="chatWindow">
    <div class="chat-header">
        <button onclick="closeChat()">×</button>
        <button onclick="goBack()">←</button>
        <h3 id="chatTitle">Conversation</h3>
        <div class="chat-options">
            <button onclick="showOptions()">⋮</button>
            <div class="options-menu" id="optionsMenu" style="display:none;">
                <a href="#" onclick="viewProfile()">View Profile</a>
            </div>
        </div>
    </div>
    <div id="chatContent">Conversation content loads here...</div>
    <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
        <input type="file" id="mediaInput" accept="image/*,video/*">
        <button onclick="uploadMedia()">Upload</button>
    </div>
</div>

<script>
    function showTab(tabId) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelectorAll('.new-group-form, .chat-window').forEach(el => el.classList.remove('active'));
        document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
        document.getElementById(tabId).classList.add('active');
        if (tabId === 'new') {
            document.querySelector('.new-group-form').classList.add('active');
        }
    }

    let debounceTimer;
    function searchInbox() {
        clearTimeout(debounceTimer);
        const searchTerm = document.getElementById('searchInput').value.trim();
        const searchResults = document.getElementById('search-results');
        
        if (!searchTerm) {
            searchResults.innerHTML = '<p>Start typing to search for mutual friends or groups.</p>';
            return;
        }

        debounceTimer = setTimeout(() => {
            fetch(`/api/search_inbox?term=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    searchResults.innerHTML = '';
                    if (data.results.length === 0) {
                        searchResults.innerHTML = '<p>No mutual friends or groups found.</p>';
                        return;
                    }
                    data.results.forEach(item => {
                        if (item.type === 'user') {
                            const user = item.data;
                            const html = `
                                <div class="user-item" onclick="openChat(${user.id})">
                                    <img src="${user.profilePhoto}" alt="Profile">
                                    <div class="user-info">
                                        <h3>${user.real_name}</h3>
                                        <p>@${user.username}</p>
                                    </div>
                                    <div class="user-actions">
                                        <button disabled>Following</button>
                                    </div>
                                </div>`;
                            searchResults.insertAdjacentHTML('beforeend', html);
                        } else if (item.type === 'group') {
                            const group = item.data;
                            const html = `
                                <div class="group-item" onclick="openGroupChat(${group.id})">
                                    <img src="${group.profilePhoto}" alt="Group">
                                    <div class="group-info">
                                        <h3>${group.name}</h3>
                                        <p>${group.description || 'No description'}</p>
                                    </div>
                                    <div class="group-actions">
                                        <button disabled>Member</button>
                                    </div>
                                </div>`;
                            searchResults.insertAdjacentHTML('beforeend', html);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error searching inbox:', error);
                    searchResults.innerHTML = '<p>Error searching users or groups. Please try again.</p>';
                });
        }, 300); // Debounce for 300ms
    }

    function openChat(userId) {
        document.querySelector('.chat-window').classList.add('active');
        fetch(`/api/chat/${userId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('chatTitle').textContent = data.user.real_name;
                document.getElementById('chatContent').innerHTML = data.messages.map(msg => `
                    <p><strong>${msg.sender}:</strong> ${msg.content}</p>
                `).join('');
            });
    }

    function openGroupChat(groupId) {
        document.querySelector('.chat-window').classList.add('active');
        fetch(`/api/group_chat/${groupId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('chatTitle').textContent = data.group.name;
                document.getElementById('chatContent').innerHTML = data.messages.map(msg => `
                    <p><strong>${msg.sender}:</strong> ${msg.content}</p>
                `).join('');
            });
    }

    function closeChat() {
        document.querySelector('.chat-window').classList.remove('active');
        document.getElementById('chatContent').innerHTML = 'Conversation content loads here...';
    }

    function goBack() {
        closeChat();
        showTab('chats');
    }

    function showOptions() {
        const menu = document.getElementById('optionsMenu');
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    function viewProfile() {
        alert('Profile view not implemented yet.');
    }

    function sendMessage() {
        const message = document.getElementById('messageInput').value;
        alert('Message sending not implemented yet.');
    }

    function uploadMedia() {
        const file = document.getElementById('mediaInput').files[0];
        alert('Media upload not implemented yet.');
    }
</script>
{% endblock %}
